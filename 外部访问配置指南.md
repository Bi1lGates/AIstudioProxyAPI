# AI Studio Proxy API - 外部访问配置完整指南

本文档提供了在阿里云ECS服务器上配置AI Studio Proxy API外部访问的完整步骤。

## 📋 目录

- [系统概述](#系统概述)
- [API Key管理](#api-key管理)
- [网络配置](#网络配置)
- [安全建议](#安全建议)
- [测试验证](#测试验证)
- [客户端使用示例](#客户端使用示例)

---

## 系统概述

### 当前部署环境

- **服务器**: 阿里云 ECS (IP: 8.217.6.233)
- **容器化**: Docker + Docker Compose
- **网络模式**: host (容器直接使用主机网络)
- **服务端口**: 2048 (FastAPI主服务)
- **代理端口**: 3120 (内部Stream代理)
- **代理配置**: http://127.0.0.1:20171 (访问Google服务必需)

### 服务架构

```
客户端 → 阿里云安全组 → ECS服务器:2048 → Docker容器 → FastAPI服务 → Stream代理 → Google AI Studio
                                                      ↓
                                               Camoufox浏览器
```

---

## API Key管理

### 1. 密钥文件位置

API密钥存储在：`~/AIstudioProxyAPI/auth_profiles/key.txt`

### 2. 密钥管理方法

#### 方法A：手动编辑文件（推荐）

```bash
# 在服务器上执行
cd ~/AIstudioProxyAPI/auth_profiles

# 添加第一个密钥
echo "sk-your-first-api-key-here" > key.txt

# 添加更多密钥（每行一个）
echo "sk-your-second-api-key" >> key.txt
echo "sk-your-third-api-key" >> key.txt

# 查看当前密钥列表（注意安全！）
cat key.txt

# 重启容器以加载新密钥
cd ~/AIstudioProxyAPI/docker
docker compose restart
```

**密钥格式要求**：
- 最少8个字符
- 每行一个密钥
- 支持空行（会被忽略）
- 不支持注释行

**示例 key.txt 内容**：
```
sk-my-first-api-key-123456
sk-production-key-abcdef
sk-test-key-xyz789
```

#### 方法B：通过API管理（需要先配置网络访问）

```bash
# 添加密钥
curl --noproxy "*" -X POST http://127.0.0.1:2048/api/keys \
  -H "Content-Type: application/json" \
  -d '{"key":"sk-your-new-api-key"}'

# 测试密钥有效性
curl --noproxy "*" -X POST http://127.0.0.1:2048/api/keys/test \
  -H "Content-Type: application/json" \
  -d '{"key":"sk-your-api-key"}'

# 获取密钥列表
curl --noproxy "*" http://127.0.0.1:2048/api/keys

# 删除密钥
curl --noproxy "*" -X DELETE http://127.0.0.1:2048/api/keys \
  -H "Content-Type: application/json" \
  -d '{"key":"sk-key-to-delete"}'
```

### 3. 密钥验证机制

**重要特性**：
- ✅ 如果`key.txt`为空或不存在，**不需要认证**（开发模式）
- ✅ 如果配置了密钥，**所有API请求都需要认证**（生产模式）
- ✅ 支持两种认证方式：
  - `Authorization: Bearer your-api-key`（推荐，OpenAI兼容）
  - `X-API-Key: your-api-key`（向后兼容）
- ✅ 密钥在日志中会被打码显示（如：`sk-ab****ef`）

**不需要认证的端点**：
- `/health` - 健康检查
- `/v1/models` - 模型列表
- `/api/info` - API信息
- `/api/keys/*` - 密钥管理端点

---

## 网络配置

### 1. 阿里云安全组配置（必需）

这是外部访问的**关键步骤**！

#### 步骤：

1. **登录阿里云控制台**
   - 访问 https://ecs.console.aliyun.com

2. **找到你的ECS实例**
   - 实例ID类似：`iZj6ccfn3ibh7jaxx9ecosZ`

3. **配置安全组规则**
   - 点击实例 → 安全组 → 配置规则
   - 添加**入方向规则**：

   ```
   规则方向：入方向
   授权策略：允许
   协议类型：TCP
   端口范围：2048/2048
   授权对象：0.0.0.0/0（允许所有IP，或指定特定IP）
   优先级：1
   描述：AI Studio Proxy API
   ```

4. **保存规则**
   - 规则立即生效，无需重启实例

### 2. 服务器防火墙配置

#### 检查防火墙状态

```bash
# 检查firewalld状态
sudo systemctl status firewalld

# 或检查ufw状态
sudo ufw status
```

#### 如果使用firewalld

```bash
# 开放端口
sudo firewall-cmd --zone=public --add-port=2048/tcp --permanent
sudo firewall-cmd --reload

# 验证规则
sudo firewall-cmd --list-ports
```

#### 如果使用ufw

```bash
# 开放端口
sudo ufw allow 2048/tcp

# 查看规则
sudo ufw status numbered
```

### 3. 配置no_proxy环境变量

由于服务器配置了代理访问Google，需要让本地curl测试时不走代理：

```bash
# 临时设置
export no_proxy="localhost,127.0.0.1"

# 永久设置（推荐）
echo 'export no_proxy="localhost,127.0.0.1"' >> ~/.bashrc
source ~/.bashrc
```

---

## 安全建议

### 1. 强密钥策略

```bash
# 生成强随机密钥（推荐）
openssl rand -base64 32 | tr -d '=' | tr '+/' '-_'

# 示例输出：
# sk-Kj8mNp2QrT5vWxYz3AbCdEfGhIjKlMnOpQrStUvWx
```

### 2. 限制访问IP（生产环境推荐）

在阿里云安全组规则中，将授权对象从`0.0.0.0/0`改为：
- 你的办公室IP
- 你的家庭IP
- 你的VPN服务器IP

示例：`123.45.67.89/32`（只允许这一个IP）

### 3. 使用HTTPS（可选，推荐）

#### 使用Nginx反向代理 + Let's Encrypt

```bash
# 安装Nginx和Certbot
sudo apt update
sudo apt install nginx certbot python3-certbot-nginx

# 配置Nginx反向代理
sudo nano /etc/nginx/sites-available/ai-studio-proxy

# 添加以下配置：
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:2048;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 启用配置
sudo ln -s /etc/nginx/sites-available/ai-studio-proxy /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 申请SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 4. 监控和日志

```bash
# 实时查看服务日志
cd ~/AIstudioProxyAPI/docker
docker compose logs -f

# 查看最近100行日志
docker compose logs --tail=100

# 只看错误日志
docker compose logs | grep ERROR
```

---

## 测试验证

### 1. 服务器本地测试

```bash
# 测试健康检查
curl --noproxy "*" http://127.0.0.1:2048/health

# 测试模型列表
curl --noproxy "*" http://127.0.0.1:2048/v1/models

# 测试聊天（无需认证，如果key.txt为空）
curl --noproxy "*" http://127.0.0.1:2048/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.5-flash",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": false
  }'

# 测试聊天（需要认证，如果配置了密钥）
curl --noproxy "*" http://127.0.0.1:2048/v1/chat/completions \
  -H "Authorization: Bearer sk-your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.5-flash",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": false
  }'
```

### 2. 外部访问测试

```bash
# 从你的本地电脑测试
# 测试健康检查
curl http://8.217.6.233:2048/health

# 测试模型列表
curl http://8.217.6.233:2048/v1/models

# 测试聊天（需要认证）
curl http://8.217.6.233:2048/v1/chat/completions \
  -H "Authorization: Bearer test1" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.5-pro",
    "messages": [{"role": "user", "content": "模仿海子，写一首关于AI的诗"}],
    "stream": false
  }'
```

### 3. 流式响应测试

```bash
curl http://8.217.6.233:2048/v1/chat/completions \
  -H "Authorization: Bearer test1" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.5-pro",
    "messages": [{"role": "user", "content": "模仿海子，写一首关于AI的诗"}],
    "stream": true
  }' \
  --no-buffer
```

---

## 客户端使用示例

### 1. Python客户端

```python
import requests

API_BASE = "http://8.217.6.233:2048/v1"
API_KEY = "sk-your-api-key"

def chat(message):
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "gemini-2.5-flash",
        "messages": [
            {"role": "user", "content": message}
        ],
        "stream": False
    }

    response = requests.post(
        f"{API_BASE}/chat/completions",
        headers=headers,
        json=data
    )

    if response.status_code == 200:
        return response.json()["choices"][0]["message"]["content"]
    else:
        return f"Error: {response.status_code} - {response.text}"

# 使用示例
result = chat("你好，请介绍一下你自己")
print(result)
```

### 2. OpenAI Python SDK

```python
from openai import OpenAI

client = OpenAI(
    api_key="sk-your-api-key",
    base_url="http://8.217.6.233:2048/v1"
)

# 非流式
response = client.chat.completions.create(
    model="gemini-2.5-flash",
    messages=[
        {"role": "user", "content": "Hello"}
    ]
)
print(response.choices[0].message.content)

# 流式
stream = client.chat.completions.create(
    model="gemini-2.5-flash",
    messages=[{"role": "user", "content": "写一首诗"}],
    stream=True
)

for chunk in stream:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="")
```

### 3. Node.js客户端

```javascript
const axios = require('axios');

const API_BASE = 'http://8.217.6.233:2048/v1';
const API_KEY = 'sk-your-api-key';

async function chat(message) {
    try {
        const response = await axios.post(
            `${API_BASE}/chat/completions`,
            {
                model: 'gemini-2.5-flash',
                messages: [
                    { role: 'user', content: message }
                ],
                stream: false
            },
            {
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        return response.data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error.response?.data || error.message);
        throw error;
    }
}

// 使用示例
chat('Hello, how are you?').then(console.log);
```

### 4. 配置Open WebUI

1. **打开Open WebUI设置**
2. **添加连接**：
   - API基础URL：`http://8.217.6.233:2048/v1`
   - API密钥：`sk-your-api-key`
3. **保存并测试连接**

---

## 常见问题排查

### 问题1：curl没有响应

**检查步骤**：
```bash
# 1. 检查服务是否运行
docker ps | grep ai-studio-proxy

# 2. 检查端口是否监听
sudo netstat -tlnp | grep 2048

# 3. 检查本地访问是否正常
curl --noproxy "*" http://127.0.0.1:2048/health

# 4. 如果本地正常但外部不通，检查安全组配置
```

### 问题2：401 Unauthorized

**原因**：API密钥配置错误

**解决**：
```bash
# 检查key.txt文件
cat ~/AIstudioProxyAPI/auth_profiles/key.txt

# 确认请求使用了正确的密钥
curl -v http://8.217.6.233:2048/v1/chat/completions \
  -H "Authorization: Bearer sk-your-actual-key" \
  ...
```

### 问题3：503 Service Unavailable

**原因**：通过代理访问本地服务

**解决**：
```bash
# 使用--noproxy参数
curl --noproxy "*" http://127.0.0.1:2048/health

# 或设置no_proxy环境变量
export no_proxy="localhost,127.0.0.1"
```

### 问题4：页面初始化失败

**原因**：认证文件过期或IP不匹配

**解决**：
```bash
# 查看日志
docker compose logs -f | grep ERROR

# 重新生成认证文件（需要在本地操作）
# 然后上传到服务器
scp auth_profiles/saved/as_2.json root@8.217.6.233:~/AIstudioProxyAPI/auth_profiles/active/

# 重启服务
docker compose restart
```

---

## 维护和更新

### 日常维护

```bash
# 查看服务状态
docker compose ps

# 查看资源使用
docker stats ai-studio-proxy-container

# 清理旧日志
find ~/AIstudioProxyAPI/logs -name "*.log" -mtime +7 -delete
```

### 更新服务

```bash
cd ~/AIstudioProxyAPI/docker

# 拉取最新代码
cd ..
git pull

# 重新构建并启动
cd docker
docker compose build
docker compose up -d

# 查看日志确认
docker compose logs -f
```

---

## 快速参考

### 常用命令速查

```bash
# 启动服务
docker compose up -d

# 停止服务
docker compose down

# 重启服务
docker compose restart

# 查看日志
docker compose logs -f

# 查看状态
docker compose ps

# 进入容器
docker compose exec ai-studio-proxy bash

# 测试API（本地）
curl --noproxy "*" http://127.0.0.1:2048/health

# 测试API（外部）
curl http://8.217.6.233:2048/v1/models
```

### API端点速查

| 端点 | 方法 | 认证 | 说明 |
|------|------|------|------|
| `/health` | GET | ❌ | 健康检查 |
| `/v1/models` | GET | ❌ | 模型列表 |
| `/api/info` | GET | ❌ | API信息 |
| `/v1/chat/completions` | POST | ✅ | 聊天接口 |
| `/v1/queue` | GET | ❌ | 队列状态 |
| `/api/keys` | GET | ❌ | 获取密钥列表 |
| `/api/keys` | POST | ❌ | 添加密钥 |
| `/api/keys/test` | POST | ❌ | 测试密钥 |
| `/api/keys` | DELETE | ❌ | 删除密钥 |

---

## 总结

完成以上配置后，你的AI Studio Proxy API将可以：

✅ 从外部通过公网IP访问
✅ 使用API密钥保护敏感接口
✅ 支持OpenAI兼容的客户端
✅ 提供稳定的流式和非流式响应
✅ 支持多种编程语言集成

**下一步建议**：
1. 配置强密钥并启用认证
2. 在阿里云安全组中限制访问IP
3. 考虑配置HTTPS（如果有域名）
4. 定期查看日志和监控服务状态

如有问题，请查看项目文档或提交Issue。
