# 快照保存权限问题解决方案

## 问题表现

快照保存时出现权限错误，日志可能显示：

```
[req_id] 尝试保存错误快照 (thinking_budget_error)...
[req_id]   保存屏幕截图失败 (thinking_budget_error): [Errno 13] Permission denied: '/app/errors_py/thinking_budget_error_xxx.png'
```

或者：

```
[req_id]   创建错误目录或保存快照时发生其他错误 (thinking_budget_error): [Errno 13] Permission denied: '/app/errors_py'
```

## 根本原因

Docker 容器以非 root 用户（`appuser`）运行，但 `errors_py` 目录可能：
1. 不存在（需要首次创建）
2. 属于 root 用户（Docker 自动创建的挂载点）
3. 权限设置不正确（不可写）

## 诊断步骤

### 1. 检查容器内的用户和权限

```bash
# 查看容器运行的用户
docker exec -it ai-studio-proxy-container whoami
# 应该显示: appuser

# 查看容器内 errors_py 目录权限
docker exec -it ai-studio-proxy-container ls -la /app/ | grep errors
# 检查输出的所有者和权限
```

**正常输出应该是**：
```
drwxr-xr-x  2 appuser appgroup  4096 Oct 23 06:00 errors_py
```

**如果看到以下情况说明有问题**：
```
drwxr-xr-x  2 root    root      4096 Oct 23 06:00 errors_py    # ← 所有者是 root
drwx------  2 appuser appgroup  4096 Oct 23 06:00 errors_py    # ← 权限太严格（只有 rwx------）
```

### 2. 检查宿主机目录权限

```bash
# 在宿主机上检查
ls -la /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/ | grep errors

# 检查是否存在以及权限
```

### 3. 尝试手动创建文件测试

```bash
# 在容器内尝试创建文件
docker exec -it ai-studio-proxy-container bash -c "touch /app/errors_py/test.txt"

# 如果失败，会显示: Permission denied
# 如果成功，验证文件是否出现在宿主机
ls -la /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py/
```

## 解决方案

### 方案 1：在宿主机创建并设置正确权限（推荐）

**步骤 1：在宿主机创建目录**

```bash
cd /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI

# 创建 errors_py 目录
mkdir -p errors_py

# 设置权限为 777（最宽松，确保容器能写入）
chmod 777 errors_py

# 验证权限
ls -la | grep errors
# 应该显示: drwxrwxrwx ... errors_py
```

**步骤 2：重启容器使挂载生效**

```bash
cd docker
docker compose down
docker compose up -d
```

**步骤 3：验证**

```bash
# 在容器内测试创建文件
docker exec -it ai-studio-proxy-container bash -c "echo test > /app/errors_py/test.txt"

# 在宿主机查看
cat /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py/test.txt
# 应该显示: test
```

### 方案 2：修改现有目录权限

**如果 errors_py 已经存在但权限不对**：

```bash
cd /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI

# 递归修改权限
sudo chmod -R 777 errors_py

# 或者只修改目录权限，保持文件权限不变
sudo chmod 777 errors_py

# 如果所有者是 root，改为当前用户
sudo chown -R $(whoami):$(whoami) errors_py
```

### 方案 3：在容器内修复权限（临时方案）

```bash
# 以 root 用户进入容器
docker exec -it --user root ai-studio-proxy-container bash

# 在容器内创建并设置权限
mkdir -p /app/errors_py
chown -R appuser:appgroup /app/errors_py
chmod 755 /app/errors_py

# 退出容器
exit
```

**注意**：容器重启后可能需要重新设置。

### 方案 4：修改 Dockerfile（永久方案）

在 Dockerfile 中添加 errors_py 目录创建。

**位置**：`docker/Dockerfile:76`

**修改前**：
```dockerfile
# 创建目录和设置权限
RUN mkdir -p /app/logs \
    /app/auth_profiles/active \
    /app/auth_profiles/saved \
    /app/certs \
    /app/browser_utils/custom_scripts \
    /home/appuser/.cache/ms-playwright \
    /home/appuser/.mozilla \
    /var/cache/camoufox && \
```

**修改后**：
```dockerfile
# 创建目录和设置权限
RUN mkdir -p /app/logs \
    /app/errors_py \
    /app/auth_profiles/active \
    /app/auth_profiles/saved \
    /app/certs \
    /app/browser_utils/custom_scripts \
    /home/appuser/.cache/ms-playwright \
    /home/appuser/.mozilla \
    /var/cache/camoufox && \
```

**然后重新构建镜像**：
```bash
cd docker
docker compose down
docker compose build --no-cache
docker compose up -d
```

### 方案 5：使用更宽松的权限策略（不推荐但最简单）

**修改 docker-compose.yml**，以 root 用户运行（不安全）：

```yaml
services:
  ai-studio-proxy:
    # ... 其他配置 ...
    user: "0:0"  # ← 添加这行，使用 root 用户
```

**不推荐原因**：
- 安全风险
- 违反最小权限原则
- 可能导致其他权限问题

## 推荐的完整解决流程

### 第一次部署

```bash
# 1. 在宿主机创建目录并设置权限
cd /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI
mkdir -p errors_py
chmod 777 errors_py

# 2. 验证 docker-compose.yml 中的挂载配置
grep "errors_py" docker/docker-compose.yml
# 应该包含: - ../errors_py:/app/errors_py

# 3. 启动容器
cd docker
docker compose up -d

# 4. 验证权限
docker exec -it ai-studio-proxy-container ls -la /app/ | grep errors
# 应该显示: drwxrwxrwx ... appuser appgroup ... errors_py

# 5. 测试写入
docker exec -it ai-studio-proxy-container bash -c "echo test > /app/errors_py/test.txt"
cat errors_py/test.txt  # 在宿主机验证
```

### 已有容器出现权限问题

```bash
# 1. 停止容器
cd docker
docker compose down

# 2. 修复宿主机权限
cd ..
sudo chmod 777 errors_py
sudo chown -R $(whoami):$(whoami) errors_py

# 3. 重启容器
cd docker
docker compose up -d

# 4. 验证
docker exec -it ai-studio-proxy-container bash -c "touch /app/errors_py/test2.txt"
ls -la errors_py/
```

## 不同操作系统的注意事项

### macOS

```bash
# macOS 用户通常没有权限问题，因为 Docker Desktop 自动处理权限映射
# 如果有问题，使用 chmod 777 即可

mkdir -p errors_py
chmod 777 errors_py
```

### Linux

```bash
# Linux 需要特别注意 UID/GID 映射

# 查看宿主机用户的 UID
id -u  # 例如: 1000

# 查看容器内 appuser 的 UID
docker exec -it ai-studio-proxy-container id -u appuser  # 通常是系统分配的，如 999

# 方案 1: 使用 777 权限（最简单）
mkdir -p errors_py
chmod 777 errors_py

# 方案 2: 匹配 UID（更安全）
# 如果容器内 appuser UID 是 999
sudo chown -R 999:999 errors_py
chmod 755 errors_py
```

### Windows (WSL2)

```bash
# WSL2 环境类似 Linux
cd /mnt/c/Users/yourname/project/AIstudioProxyAPI

mkdir -p errors_py
chmod 777 errors_py
```

## 验证权限修复成功

### 方法 1：查看日志

触发一个错误，查看快照是否保存成功：

```bash
# 查看最新日志
docker logs ai-studio-proxy-container --tail 100 | grep "快照已保存"

# 应该看到:
# [req_id]   快照已保存到: /app/errors_py/xxx.png
# [req_id]   HTML 已保存到: /app/errors_py/xxx.html
```

### 方法 2：检查文件是否存在

```bash
# 在宿主机查看
ls -lh /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py/

# 应该看到 .png 和 .html 文件
```

### 方法 3：查看文件所有者

```bash
# 宿主机
ls -la errors_py/
# 文件应该属于当前用户

# 容器内
docker exec -it ai-studio-proxy-container ls -la /app/errors_py/
# 文件应该属于 appuser
```

## 常见错误和解决方案

### 错误 1：`Permission denied: '/app/errors_py'`

**原因**：目录不存在或容器无权限创建

**解决**：
```bash
# 在宿主机创建
mkdir -p /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py
chmod 777 errors_py

# 重启容器
docker compose restart
```

### 错误 2：`Permission denied: '/app/errors_py/xxx.png'`

**原因**：目录存在但不可写

**解决**：
```bash
chmod 777 /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py
docker compose restart
```

### 错误 3：文件在容器内创建成功，但宿主机看不到

**原因**：挂载配置错误

**解决**：
```bash
# 检查 docker-compose.yml
grep "errors_py" docker/docker-compose.yml

# 应该有:
# - ../errors_py:/app/errors_py

# 如果没有，添加后重启
docker compose down
docker compose up -d
```

### 错误 4：宿主机有文件，但容器内看不到

**原因**：挂载后容器内的目录被覆盖

**解决**：
```bash
# 重启容器，Docker 会同步挂载
docker compose restart

# 验证
docker exec -it ai-studio-proxy-container ls /app/errors_py/
```

### 错误 5：`Read-only file system`

**原因**：挂载为只读模式

**检查 docker-compose.yml**：
```yaml
volumes:
  - ../errors_py:/app/errors_py:ro  # ← 移除 :ro
```

**应该是**：
```yaml
volumes:
  - ../errors_py:/app/errors_py  # ← 正确，读写模式
```

## 预防措施

### 1. 在 docker-compose.yml 中添加注释

```yaml
volumes:
  # 挂载错误快照目录（需要宿主机先创建并设置权限 chmod 777）
  - ../errors_py:/app/errors_py
```

### 2. 在 README 或安装文档中说明

```markdown
## Docker 部署前准备

1. 创建必要的目录：
   ```bash
   mkdir -p errors_py auth_profiles/active auth_profiles/saved
   chmod 777 errors_py
   ```

2. 启动容器：
   ```bash
   cd docker
   docker compose up -d
   ```
```

### 3. 在 Dockerfile 中预创建目录（推荐）

已在方案 4 中说明，修改 Dockerfile line 76。

## 快速诊断脚本

创建一个诊断脚本自动检查权限：

```bash
#!/bin/bash
# 文件名: check_permissions.sh

echo "=== 检查 errors_py 权限 ==="

# 检查宿主机
echo "1. 宿主机目录:"
ls -la /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/ | grep errors

# 检查容器内
echo -e "\n2. 容器内目录:"
docker exec -it ai-studio-proxy-container ls -la /app/ | grep errors 2>/dev/null

# 测试写入
echo -e "\n3. 测试写入权限:"
docker exec -it ai-studio-proxy-container bash -c "touch /app/errors_py/test_$(date +%s).txt" 2>/dev/null
if [ $? -eq 0 ]; then
    echo "✅ 写入成功"
else
    echo "❌ 写入失败 - 需要修复权限"
fi

echo -e "\n4. 已有快照文件:"
ls -lh /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py/ 2>/dev/null | head -5
```

**使用方法**：
```bash
chmod +x check_permissions.sh
./check_permissions.sh
```

## 总结

**最简单快速的解决方案**：

```bash
# 1. 创建目录并设置宽松权限
mkdir -p /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py
chmod 777 /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py

# 2. 重启容器
cd docker
docker compose restart

# 3. 验证
docker exec -it ai-studio-proxy-container bash -c "echo test > /app/errors_py/test.txt"
cat /Users/liuyuan/Project/AS服务器/AIstudioProxyAPI/errors_py/test.txt
```

**完成后应该看到**：
- ✅ 日志显示快照保存成功
- ✅ errors_py 目录下有 .png 和 .html 文件
- ✅ 宿主机和容器内都能看到文件
