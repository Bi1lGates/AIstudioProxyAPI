# 修复思考预算调整错误时缺少快照保存

## 问题描述

当调整思考预算（`reasoning_effort`）失败时，系统会记录错误日志，但**不会保存快照**，导致无法通过截图排查问题。

**错误示例**：
```
2025-10-23 06:26:00,351 - ERROR - [AIStudioProxyServer:_adjust_thinking_budget:164] - [03url9n] ❌ 调整思考预算时出错: Locator expected to be visible
Actual value: <element(s) not found>
```

**影响**：
- 无法查看失败时的页面状态
- 难以定位是否是选择器问题、UI 变化还是其他原因
- 不符合其他参数调整方法的统一错误处理模式

## 根本原因

`_adjust_thinking_budget` 方法的异常处理中缺少 `save_error_snapshot()` 调用。

**代码位置**：`browser_utils/page_controller.py:163-166`

**当前代码**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**对比其他方法**（如 `_adjust_temperature`）：
```python
except Exception as pw_err:
    self.logger.error(f"[{self.req_id}] ❌ 操作温度输入框时发生错误: {pw_err}。清除缓存中的温度。")
    page_params_cache.pop("temperature", None)
    await save_error_snapshot(f"temperature_playwright_error_{self.req_id}")  # ← 有快照
    if isinstance(pw_err, ClientDisconnectedError):
        raise
```

## 修复方案

### 方案 1：简单修复（推荐）

直接添加快照保存调用。

**位置**：`browser_utils/page_controller.py:163-166`

**修改前**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**修改后**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
    await save_error_snapshot(f"thinking_budget_error_{self.req_id}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**改动说明**：
- 添加 `await save_error_snapshot(f"thinking_budget_error_{self.req_id}")`
- 保存位置：错误日志之后、ClientDisconnectedError 检查之前
- 快照文件名：`thinking_budget_error_{req_id}_{timestamp}.png/html`

### 方案 2：完整修复（更严谨）

按照其他方法的模式，分类处理不同类型的异常。

**修改前**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**修改后**：
```python
except (ValueError, TypeError) as ve:
    self.logger.error(f"[{self.req_id}] 转换思考预算值时出错: {ve}")
    await save_error_snapshot(f"thinking_budget_value_error_{self.req_id}")
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
    await save_error_snapshot(f"thinking_budget_error_{self.req_id}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**改动说明**：
- 分别处理值转换错误和其他错误
- 不同错误使用不同的快照文件名前缀
- 更容易区分错误类型

### 推荐选择

**方案 1（简单修复）** - 因为：
1. 修改最小，风险低
2. 已经满足需求（能保存快照排查问题）
3. 方法内部已经有值验证逻辑（line 141-143）

## 完整的修改补丁

### 文件：browser_utils/page_controller.py

```diff
@@ -160,9 +160,10 @@ class PageController:
             else:
                 self.logger.warning(f"[{self.req_id}] ⚠️ 思考预算更新后验证失败。页面显示: {new_value_str}, 期望: {token_budget}")

         except Exception as e:
             self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
+            await save_error_snapshot(f"thinking_budget_error_{self.req_id}")
             if isinstance(e, ClientDisconnectedError):
                 raise

     def _should_enable_google_search(self, request_params: Dict[str, Any]) -> bool:
```

## 需要导入的依赖

检查文件开头是否已导入 `save_error_snapshot`：

**位置**：`browser_utils/page_controller.py:26`

**应该包含**：
```python
from .operations import save_error_snapshot, _wait_for_response_completion, _get_final_response_content
```

如果没有，需要添加导入：
```python
from .operations import save_error_snapshot
```

## 同样的问题检查

检查其他方法是否也缺少快照保存：

### 1. _adjust_google_search（line 188-222）

**当前代码**（line 219-222）：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 操作 'Google Search toggle' 开关时发生错误: {e}")
    if isinstance(e, ClientDisconnectedError):
         raise
```

**缺少快照！建议修复**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 操作 'Google Search toggle' 开关时发生错误: {e}")
    await save_error_snapshot(f"google_search_toggle_error_{self.req_id}")
    if isinstance(e, ClientDisconnectedError):
         raise
```

### 2. _control_thinking_budget_toggle（line 269-300）

检查是否有快照保存... （需要查看完整代码）

### 3. _open_url_content（line 249-267）

**当前代码**（line 264-267）：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 操作 USE_URL_CONTEXT_SELECTOR 时发生错误:{e}。")
    if isinstance(e, ClientDisconnectedError):
        raise
```

**缺少快照！建议修复**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 操作 USE_URL_CONTEXT_SELECTOR 时发生错误:{e}。")
    await save_error_snapshot(f"url_context_error_{self.req_id}")
    if isinstance(e, ClientDisconnectedError):
        raise
```

### 4. _ensure_tools_panel_expanded（line 224-247）

**当前代码**（line 243-247）：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 展开工具面板时发生错误: {e}")
    # 即使出错，也继续尝试执行后续操作，但记录错误
    if isinstance(e, ClientDisconnectedError):
        raise
```

**缺少快照！建议修复**：
```python
except Exception as e:
    self.logger.error(f"[{self.req_id}] ❌ 展开工具面板时发生错误: {e}")
    await save_error_snapshot(f"tools_panel_expand_error_{self.req_id}")
    # 即使出错，也继续尝试执行后续操作，但记录错误
    if isinstance(e, ClientDisconnectedError):
        raise
```

## 批量修复建议

建议**一次性修复所有缺少快照保存的错误处理**，以保持代码一致性。

### 修复清单

- [ ] `_adjust_thinking_budget` - 调整思考预算
- [ ] `_adjust_google_search` - 调整 Google Search 开关
- [ ] `_open_url_content` - 打开 URL Context
- [ ] `_ensure_tools_panel_expanded` - 展开工具面板
- [ ] `_control_thinking_budget_toggle` - 控制思考预算开关（需确认）

### 完整补丁（批量修复）

```diff
@@ -160,9 +160,10 @@ class PageController:
             else:
                 self.logger.warning(f"[{self.req_id}] ⚠️ 思考预算更新后验证失败。页面显示: {new_value_str}, 期望: {token_budget}")

         except Exception as e:
             self.logger.error(f"[{self.req_id}] ❌ 调整思考预算时出错: {e}")
+            await save_error_snapshot(f"thinking_budget_error_{self.req_id}")
             if isinstance(e, ClientDisconnectedError):
                 raise

@@ -217,9 +218,10 @@ class PageController:
                     self.logger.warning(f"[{self.req_id}] ⚠️ Google Search 开关{action}失败。当前状态: '{new_state}'")
             else:
                 self.logger.info(f"[{self.req_id}] Google Search 开关已处于期望状态，无需操作。")

         except Exception as e:
             self.logger.error(f"[{self.req_id}] ❌ 操作 'Google Search toggle' 开关时发生错误: {e}")
+            await save_error_snapshot(f"google_search_toggle_error_{self.req_id}")
             if isinstance(e, ClientDisconnectedError):
                  raise

@@ -243,9 +245,10 @@ class PageController:
             else:
                 self.logger.info(f"[{self.req_id}] 工具面板已处于展开状态。")
         except Exception as e:
             self.logger.error(f"[{self.req_id}] ❌ 展开工具面板时发生错误: {e}")
+            await save_error_snapshot(f"tools_panel_expand_error_{self.req_id}")
             # 即使出错，也继续尝试执行后续操作，但记录错误
             if isinstance(e, ClientDisconnectedError):
                 raise

@@ -264,9 +267,10 @@ class PageController:
             else:
                 self.logger.info(f"[{self.req_id}] URL Context 开关已处于开启状态。")
         except Exception as e:
             self.logger.error(f"[{self.req_id}] ❌ 操作 USE_URL_CONTEXT_SELECTOR 时发生错误:{e}。")
+            await save_error_snapshot(f"url_context_error_{self.req_id}")
             if isinstance(e, ClientDisconnectedError):
                 raise
```

## 测试验证

### 1. 应用修复

```bash
# 编辑文件
vim browser_utils/page_controller.py

# 应用上述修改
```

### 2. 触发错误

```bash
# 启动服务
python launch_camoufox.py --headless

# 发送一个带有 reasoning_effort 的请求
curl -X POST http://127.0.0.1:2048/v1/chat/completions \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-2.0-flash-thinking-exp-01-21",
    "messages": [{"role": "user", "content": "test"}],
    "reasoning_effort": "high",
    "stream": false
  }'
```

### 3. 验证快照保存

**如果调整思考预算失败，应该看到**：

**日志**：
```
[03url9n] ❌ 调整思考预算时出错: Locator expected to be visible
[03url9n] 尝试保存错误快照 (thinking_budget_error)...
[03url9n]   快照已保存到: /app/errors_py/thinking_budget_error_03url9n_1729662360351.png
[03url9n]   HTML 已保存到: /app/errors_py/thinking_budget_error_03url9n_1729662360351.html
```

**文件**：
```bash
ls -lh errors_py/
# 应该看到：
# thinking_budget_error_03url9n_1729662360351.png
# thinking_budget_error_03url9n_1729662360351.html
```

## 提交 PR 说明

### PR 标题

```
fix: 添加缺失的错误快照保存（思考预算等参数调整）
```

### PR 描述

```markdown
## 问题

当某些参数调整失败时（如思考预算、Google Search 开关等），系统会记录错误日志，
但不会保存快照，导致无法通过截图排查问题。

这与其他参数调整方法（temperature, max_tokens, stop_sequences, top_p）的
错误处理模式不一致。

## 修改

为以下方法的错误处理添加 `save_error_snapshot()` 调用：
1. `_adjust_thinking_budget` - 调整思考预算
2. `_adjust_google_search` - 调整 Google Search 开关
3. `_open_url_content` - 打开 URL Context
4. `_ensure_tools_panel_expanded` - 展开工具面板

## 影响

- ✅ 错误发生时能保存快照，方便排查问题
- ✅ 统一错误处理模式，提高代码一致性
- ✅ 更容易诊断选择器失效、UI 变化等问题

## 测试

已测试调整思考预算失败时能正确保存快照。
```

### PR 标签

- `bug` - 修复缺失功能
- `enhancement` - 改进错误处理
- `diagnostics` - 诊断相关

## 总结

这是一个**代码疏漏**，修复后：
1. ✅ 所有参数调整失败时都会保存快照
2. ✅ 更容易诊断选择器问题、UI 变化
3. ✅ 代码更一致、更易维护

建议批量修复所有缺少快照保存的错误处理。
